"use strict";(self["webpackChunkallsing"]=self["webpackChunkallsing"]||[]).push([[265],{3822:function(e,o,t){t.d(o,{A:function(){return b}});var i=t(6768);const n={class:"c-setting-box"},a={class:"c-setting-sliderbox"},s={class:"c-setting-sliderbox"},l={class:"c-setting-sliderbox"},r={class:"c-setting-sliderbox"};function c(e,o,t,c,u,d){const h=(0,i.g2)("van-cell"),m=(0,i.g2)("van-slider"),g=(0,i.g2)("van-radio"),b=(0,i.g2)("van-radio-group"),v=(0,i.g2)("van-dialog");return(0,i.uX)(),(0,i.Wv)(v,{show:c.isVisible,"onUpdate:show":o[4]||(o[4]=e=>c.isVisible=e),title:"设置",onClose:c.onCloseDialog},{default:(0,i.k6)((()=>[(0,i.Lk)("div",n,[(0,i.bF)(h,{title:"歌词同步",value:c.store.lrcDelayTime},null,8,["value"]),(0,i.Lk)("div",a,[(0,i.bF)(m,{modelValue:c.store.lrcDelayTime,"onUpdate:modelValue":o[0]||(o[0]=e=>c.store.lrcDelayTime=e),onChange:d.onlrcDelayChange,min:"-2",max:"2",step:"0.1"},null,8,["modelValue","onChange"])]),(0,i.bF)(h,{title:"歌词编码"}),(0,i.Lk)("div",s,[(0,i.bF)(b,{modelValue:c.store.lrcEncoding,"onUpdate:modelValue":o[1]||(o[1]=e=>c.store.lrcEncoding=e),direction:"horizontal",onChange:d.onLrcEncodingChange},{default:(0,i.k6)((()=>[(0,i.bF)(g,{name:"GBK"},{default:(0,i.k6)((()=>[(0,i.eW)("GBK")])),_:1}),(0,i.bF)(g,{name:"UTF-8"},{default:(0,i.k6)((()=>[(0,i.eW)("UTF-8")])),_:1})])),_:1},8,["modelValue","onChange"])]),(0,i.bF)(h,{title:"伴奏音量",value:100*c.store.banzouVolume},null,8,["value"]),(0,i.Lk)("div",l,[(0,i.bF)(m,{modelValue:c.store.banzouVolume,"onUpdate:modelValue":o[2]||(o[2]=e=>c.store.banzouVolume=e),onChange:d.onBanzouVolumeChange,min:"0",max:"1",step:"0.1"},null,8,["modelValue","onChange"])]),(0,i.bF)(h,{title:"伴奏音调",value:10*c.store.banzouPitch},null,8,["value"]),(0,i.Lk)("div",r,[(0,i.bF)(m,{modelValue:c.store.banzouPitch,"onUpdate:modelValue":o[3]||(o[3]=e=>c.store.banzouPitch=e),onChange:d.onBanzouPitchChange,min:"-1.1",max:"1.1",step:"0.1"},null,8,["modelValue","onChange"])])])])),_:1},8,["show","onClose"])}var u=t(5129),d=t(144),h={name:"setting",props:{visible:{type:Boolean,default:!1}},emits:["update:visible"],setup(e,{emit:o}){const t=(0,u.A)(),n=(0,d.KR)(e.visible);(0,i.wB)((()=>e.visible),(e=>{console.log(e),n.value=e}));let a=()=>{console.log("关闭对话框"),o("update:visible",!1)};return{store:t,isVisible:n,onCloseDialog:a}},methods:{onlrcDelayChange(e){this.store.parseLRC()},onLrcEncodingChange(e){this.store.readLrcText()},onBanzouVolumeChange(e){this.store.banzouVolume=e},onBanzouPitchChange(e){this.store.banzouPitch=e}}},m=t(1241);const g=(0,m.A)(h,[["render",c],["__scopeId","data-v-521478c4"]]);var b=g},9382:function(e,o,t){t.r(o),t.d(o,{default:function(){return J}});var i=t(6768),n=t(4232),a=t(5130);const s=e=>((0,i.Qi)("data-v-2c5c7cbe"),e=e(),(0,i.jt)(),e),l={class:"container compose"},r={class:"content content-compose"},c={class:"c-e-name c-e-name-crop"},u={class:"c-e-ctrlbox"},d={class:"c-e-ctrlitem"},h={class:"c-e-sliderbox-time"},m={class:"c-e-sliderbox"},g={class:"c-e-sliderbox-time"},b={class:"c-co-lrcbox"},v={class:"c-e-title"},f=s((()=>(0,i.Lk)("span",null,"伴奏音量",-1))),p={class:"c-e-voicebox c-co-voicebox"},C={class:"c-e-title"},y=s((()=>(0,i.Lk)("span",null,"压缩音频",-1))),x={class:"c-co-imgbox"},k={class:"c-co-imgtitle"},L=s((()=>(0,i.Lk)("span",null,"images:",-1))),V={class:"c-e-editbox c-co-editbox"},T=["src"],S={class:"c-co-namebox"},F={class:"c-co-itemname"},w={class:"c-co-volbox"},A={class:"c-co-volname"},D={class:"c-co-volbox"},R={class:"c-co-volname"},P={class:"c-co-volbox"},N=s((()=>(0,i.Lk)("div",{class:"c-co-volname"},"混响",-1))),z={class:"c-co-reverbbox"},_={class:"c-e-btnbox c-co-btnbox"},B={class:"c-co-innerbox"};function U(e,o,t,s,U,G){const I=(0,i.g2)("van-nav-bar"),E=(0,i.g2)("van-icon"),$=(0,i.g2)("van-slider"),W=(0,i.g2)("van-switch"),j=(0,i.g2)("van-radio"),O=(0,i.g2)("van-radio-group"),K=(0,i.g2)("van-button"),X=(0,i.g2)("SettingDialog"),q=(0,i.g2)("ReverbDialog");return(0,i.uX)(),(0,i.CE)(i.FK,null,[(0,i.Lk)("div",l,[(0,i.bF)(I,{title:"合成","left-text":"主页",onClickLeft:o[0]||(o[0]=e=>G.onBack()),"right-text":"设置",onClickRight:G.onSetting},null,8,["onClickRight"]),(0,i.Lk)("div",r,[(0,i.Lk)("div",c,(0,n.v_)(U.musicName),1),(0,i.Lk)("div",u,[(0,i.Lk)("div",d,[(0,i.bo)((0,i.bF)(E,{name:"pause-circle-o",class:"c-e-ctrlicon",onClick:G.onPause},null,8,["onClick"]),[[a.aG,U.playing]]),(0,i.bo)((0,i.bF)(E,{name:"play-circle",class:"c-e-ctrlicon",onClick:G.onPlay},null,8,["onClick"]),[[a.aG,!U.playing]])]),(0,i.Lk)("div",h,(0,n.v_)(s.util.convertTime(U.curTime)),1),(0,i.Lk)("div",m,[(0,i.bF)($,{modelValue:U.curTime,"onUpdate:modelValue":o[1]||(o[1]=e=>U.curTime=e),onChange:G.onDurationChange,max:U.audioDuration,onDragStart:o[2]||(o[2]=e=>U.dragging=!0),onDragEnd:o[3]||(o[3]=e=>U.dragging=!1)},null,8,["modelValue","onChange","max"])]),(0,i.Lk)("div",g,(0,n.v_)(s.util.convertTime(U.audioDuration)),1)]),(0,i.Lk)("div",b,(0,n.v_)(U.curLrc),1),(0,i.Lk)("div",v,[f,(0,i.Lk)("span",null,(0,n.v_)(U.accompanyVal),1)]),(0,i.Lk)("div",p,[(0,i.bF)($,{min:"0",max:"100",modelValue:U.accompanyVal,"onUpdate:modelValue":o[4]||(o[4]=e=>U.accompanyVal=e),onChange:G.onAccompanyVoiceChange},null,8,["modelValue","onChange"])]),(0,i.Lk)("div",C,[y,(0,i.bF)(W,{modelValue:s.store.compress,"onUpdate:modelValue":o[5]||(o[5]=e=>s.store.compress=e)},null,8,["modelValue"])]),(0,i.bo)((0,i.Lk)("div",x,[(0,i.Lk)("div",k,[L,(0,i.bF)(O,{modelValue:U.orient,"onUpdate:modelValue":o[6]||(o[6]=e=>U.orient=e),direction:"horizontal",onChange:G.onOrientChange},{default:(0,i.k6)((()=>[(0,i.bF)(j,{name:"0"},{default:(0,i.k6)((()=>[(0,i.eW)("landscape")])),_:1}),(0,i.bF)(j,{name:"1"},{default:(0,i.k6)((()=>[(0,i.eW)("portrait")])),_:1})])),_:1},8,["modelValue","onChange"])]),(0,i.Lk)("div",{class:(0,n.C4)("0"==U.orient?"c-co-imglist":"c-co-imglist portrait")},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(U.imgList,((e,o)=>((0,i.uX)(),(0,i.CE)("div",{class:"c-co-imgitem",key:o,style:(0,n.Tr)(G.getBg(e))},[(0,i.bF)(E,{name:"close",class:"c-co-imgrev",onClick:t=>G.onRemoveImg(e,o)},null,8,["onClick"])],4)))),128))],2)],512),[[a.aG,U.imgList.length]]),(0,i.Lk)("div",V,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(U.filelist,((e,o)=>((0,i.uX)(),(0,i.CE)("div",{class:"c-co-item",key:o},[(0,i.Lk)("audio",{src:e.file.url,ref_for:!0,ref:"setItemRef",class:"c-co-audio"},null,8,T),(0,i.Lk)("div",S,[(0,i.Lk)("div",F,(0,n.v_)(e.file.name.replace(/\.(mp3|wav)$/i,"")),1)]),(0,i.Lk)("div",w,[(0,i.Lk)("span",A,[(0,i.eW)("音量: "),(0,i.Lk)("b",null,(0,n.v_)(e.volume),1)]),(0,i.bF)($,{class:"c-co-volslider",modelValue:e.volume,"onUpdate:modelValue":o=>e.volume=o,onChange:t=>G.onVolumeChange(e,o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),(0,i.Lk)("div",D,[(0,i.Lk)("span",R,[(0,i.eW)("迟延: "),(0,i.Lk)("b",null,(0,n.v_)(e.delay),1)]),(0,i.bF)($,{min:"-2",max:"2",step:"0.1",class:"c-co-volslider c-co-volslider-delay",modelValue:e.delay,"onUpdate:modelValue":o=>e.delay=o,onChange:t=>G.onDelayChange(e,o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),(0,i.Lk)("div",P,[N,(0,i.Lk)("div",z,[(0,i.bo)((0,i.bF)(K,{plain:"",type:"primary",size:"small",class:"c-e-cusbtn",onClick:t=>G.onReverbSetting(e,o)},{default:(0,i.k6)((()=>[(0,i.eW)("设置")])),_:2},1032,["onClick"]),[[a.aG,e.reverb]]),(0,i.bF)(W,{modelValue:e.reverb,"onUpdate:modelValue":o=>e.reverb=o,onChange:t=>{G.onReverbChange(t,e,o)}},null,8,["modelValue","onUpdate:modelValue","onChange"])])]),(0,i.bF)(E,{name:"close",class:"c-co-remove",onClick:t=>G.onVoiceRemove(e,o)},null,8,["onClick"])])))),128))]),(0,i.Lk)("div",_,[(0,i.Lk)("div",B,[(0,i.Lk)("input",{type:"file",multiple:"",ref:"imgFile",style:{display:"none"},onChange:o[7]||(o[7]=(...e)=>G.onImgFileSelect&&G.onImgFileSelect(...e))},null,544),(0,i.Lk)("input",{type:"file",ref:"audioFile",style:{display:"none"},onChange:o[8]||(o[8]=(...e)=>G.onAudioFileSelect&&G.onAudioFileSelect(...e))},null,544),(0,i.bF)(K,{class:"c-e-btn",type:"primary",onClick:G.onAudioAdd},{default:(0,i.k6)((()=>[(0,i.eW)("添加人声")])),_:1},8,["onClick"]),(0,i.bF)(K,{round:"",class:"c-e-btn c-e-btn-r",type:"success",onClick:G.compose},{default:(0,i.k6)((()=>[(0,i.eW)("合成歌曲")])),_:1},8,["onClick"])])])])]),(0,i.bF)(X,{visible:U.settingShow,"onUpdate:visible":o[9]||(o[9]=e=>U.settingShow=e),data:U.curReverbData},null,8,["visible","data"]),(0,i.bF)(q,{ref:"rbDlg",onChange:G.onReverbDetailChange,onClose:o[10]||(o[10]=o=>e.curReverbItem=null)},null,8,["onChange"])],64)}t(4114),t(4603),t(7566),t(8721);var G=t(144),I=t(5129),E=t(3822),$=t(1104),W=t(9353),j=t(5846),O=t(7019),K=t(715),X=t(6230);let q;var H={name:"ComposeView",components:{SettingDialog:E.A,ReverbDialog:$.A},setup(){q=(0,X.A)(new(window.AudioContext||window.webkitAudioContext)),console.log("compose.......");const e=(0,I.A)(),o=(0,G.KR)(null);return{store:e,util:W.A,rbDlg:o}},data(){return{audioContext:null,offlineAudioCtx:null,musicName:"",audioDuration:0,curTime:0,curLrc:"",dragging:!1,accompanyVal:0,playing:!1,orient:"0",settingShow:!1,remainTime:0,imgList:[],filelist:[],rbSettingShow:!1,curReverbData:{}}},mounted(){if(!this.store.banzou)return alert("没有找到需要编辑的音频"),void this.$router.replace("/");this.audioContext=q.context,console.log(this.audioContext),this.init(this.store.banzou)},unmounted(){this.rTimer&&cancelAnimationFrame(this.rTimer);for(let o=0;o<this.filelist.length;o++){const e=this.filelist[o];e.delayPlayTimer&&(clearTimeout(e.delayPlayTimer),e.delayPlayTimer=null),e.voiceSource.disconnect(),e.voiceSource.buffer=null}this.fileList=[];try{this.bgSource.disconnect(),this.bgSource.buffer=null}catch(e){}try{this.audioContext.close()}catch(e){console.log(e)}try{this.offlineAudioCtx&&("running"==this.offlineAudioCtx.state&&this.offlineAudioCtx.suspend(this.offlineAudioCtx.currentTime),this.offlineAudioCtx=null)}catch(e){console.log(e)}console.log("hide loading"),this.store.hideLoading(),this.store.hideProgess(),(0,O.H)(),j.E.stop(),q=null},watch:{"store.banzouVolume":{handler(){this.audioContext&&(this.accompanyVal=100*this.store.banzouVolume,this.bgGain.gain.value=this.store.banzouVolume)}}},methods:{onReverbSetting(e,o){this.rbDlg.show({time:e.reverbNode.time,decay:e.reverbNode.decay,mix:e.reverbNode.mix}),this.curReverbItem=e},async init(e){this.musicName=this.store.banzou.name.replace(/\.mp3$/i,""),this.store.showLoading();const o=await this.loadAudioData(this.audioContext,e),t=o.duration;this.audioDuration=t;const i=this.audioContext.sampleRate,n=t*i,a=this.audioContext.createBuffer(2,n,i);a.getChannelData(0).set(o.getChannelData(0).subarray(0,n));let s=0;o.numberOfChannels>1&&(s=1),a.getChannelData(1).set(o.getChannelData(s).subarray(0,n));const l=this.audioContext.createBufferSource();l.buffer=a,this.bgGain=this.audioContext.createGain(),this.accompanyVal=100*this.store.banzouVolume,this.bgGain.gain.value=this.store.banzouVolume,l.connect(this.bgGain),Tone.setContext(this.audioContext);var r=new Tone.PitchShift;r.pitch=this.store.banzouPitch,Tone.connect(this.bgGain,r),Tone.connect(r,this.audioContext.destination),this.bgSource=l,this.remainTime=this.audioContext.currentTime,this.store.lrc&&await this.store.readLrcText(),this.audioContext.suspend(),l.start(),this.store.hideLoading()},loadAudioData(e,o){return new Promise(((t,i)=>{const n=new FileReader;n.onload=()=>{e.decodeAudioData(n.result).then((e=>t(e))).catch((e=>i(e)))},n.onerror=()=>i(n.error),n.readAsArrayBuffer(o)}))},setCurTime(){let e=this.audioContext.currentTime-this.remainTime;e>=this.audioDuration?this.doStop(!0):(this.dragging||(this.curTime=e),this.onTimeUpdate(),this.rTimer=requestAnimationFrame(this.setCurTime))},onAccompanyVoiceChange(e){this.bgGain&&(this.bgGain.gain.value=e/100,this.store.banzouVolume=e/100)},doStop(e){console.log(this.audioContext.state),"running"==this.audioContext.state&&(this.playing=!1,this.audioContext.suspend(),e&&(this.curTime=0,this.rTimer=null,this.remainTime=this.audioContext.currentTime))},jumpTo(e){try{this.bgSource.stop()}catch(t){}const o=this.audioContext.createBufferSource();o.buffer=this.bgSource.buffer,this.bgSource.disconnect(),this.bgSource.buffer=null,o.connect(this.bgGain),this.bgSource=o,this.bgSource.start(0,e);for(let i=0;i<this.filelist.length;i++){let o=this.filelist[i];try{o.voiceSource.stop()}catch(t){}const n=this.audioContext.createBufferSource();console.log(o.voiceSource),n.buffer=o.voiceSource.buffer,o.voiceSource.disconnect(),o.voiceSource.buffer=null,n.connect(o.gainNode),o.voiceSource=n,this.startVoiceSource(e,o)}},startVoiceSource(e=0,o){o.delayPlayTimer&&(clearTimeout(o.delayPlayTimer),o.delayPlayTimer=null);let t=0;if(t=e+o.delay,t>=0)o.voiceSource.start(0,t);else{let e=-1e3*t;t=0,o.delayPlayTimer=setTimeout((()=>{o.voiceSource.start(0,t)}),e)}},onPlay(){this.doPlay()},doPlay(){console.log(this.audioContext.state),"running"!=this.audioContext.state&&(this.playing=!0,this.audioContext.resume(),this.rTimer?this.jumpTo(this.curTime):(this.setCurTime(),this.jumpTo(0)))},onPause(){this.doStop()},onBack(){this.$router.replace("/")},setItemRef(e,o){return`voice${o}`},onTimeUpdate(){if(!this.store.parsedLyrics||!this.store.parsedLyrics.length)return;const e=this.curTime;for(let o=0;o<this.store.parsedLyrics.length;o++)if(e>=this.store.parsedLyrics[o].time&&(o===this.store.parsedLyrics.length-1||e<this.store.parsedLyrics[o+1].time)){this.curLrc=this.store.parsedLyrics[o].text;break}},getBg(e){let o=`background-image: url(${e.url}); background-repeat: no-repeat; background-position: center;`;return o},onImgFileSelect(){if(this.imgList.length>=10)return void alert("最多添加10张图片");const e=this.$refs.imgFile.files;for(let o of e){if(console.log(o.type),"image/png"!==o.type&&"image/jpeg"!==o.type){alert("只能添加图片文件 -> "+o.name);continue}if(o.size>5242880){alert("图片大小不能超过5M -> "+o.name);continue}let e=URL.createObjectURL(o);this.imgList.push({url:e})}this.$refs.imgFile.value=""},onImgAdd(){this.$refs.imgFile.click()},onRemoveImg(e,o){this.imgList.splice(o,1)},isSurpportFile(e){const o=/\.(mp3|wav)$/i;return o.test(e.name)},async onAudioFileSelect(){this.store.showLoading();const e=this.$refs.audioFile.files[0];if(!this.isSurpportFile(e))return(0,K.P0)("目前只支持 wav, mp3 格式"),void this.store.hideLoading();this.doStop();let o={reverb:!1,reverbNode:new q.Effects.Reverb({...this.store.reverbOption}),volume:100,delay:0,file:e,gainNode:null};this.filelist.push(o),await this.addVoice(o),this.$refs.audioFile.value="",this.store.hideLoading()},onAudioAdd(){this.$refs.audioFile.click()},async addVoice(e){const o=await this.loadAudioData(this.audioContext,e.file);let t=o.duration;this.audioDuration<t&&(t=this.audioDuration);const i=this.audioContext.sampleRate,n=t*i,a=this.audioContext.createBuffer(2,n,i);a.getChannelData(0).set(o.getChannelData(0).subarray(0,n));let s=0;o.numberOfChannels>1&&(s=1),a.getChannelData(1).set(o.getChannelData(s).subarray(0,n));const l=this.audioContext.createBufferSource();l.buffer=a,e.voiceSource=l;let r=this.audioContext.createGain();r.gain.value=1,e.gainNode=r,l.connect(r),r.connect(this.audioContext.destination)},async getReverb(e){this.store.showLoading();const o="audio/reverb"+e+".wav";try{const e=await fetch(o);if(!e.ok)throw new Error("Network response was not ok "+e.statusText);const t=await e.arrayBuffer(),i=await this.audioContext.decodeAudioData(t);return console.log(i),this.store.hideLoading(),i}catch(t){return console.error("There has been a problem with your fetch operation:",t),this.store.hideLoading(),null}},async onReverbChange(e,o,t){e?(o.gainNode.disconnect(),o.gainNode.connect(o.reverbNode),o.reverbNode.connect(this.audioContext.destination)):(o.gainNode.disconnect(),o.reverbNode.disconnect(),o.gainNode.connect(this.audioContext.destination))},onReverbDetailChange(e){this.curReverbItem&&(this.curReverbItem.reverbNode.time=e.time,this.curReverbItem.reverbNode.decay=e.decay,this.curReverbItem.reverbNode.mix=e.mix)},onVolumeChange(e,o){console.log(e,o),e.gainNode.gain.value=e.volume/100},onDelayChange(e,o){this.jumpTo(this.curTime)},onSetting(){this.settingShow=!0},onDurationChange(e){this.remainTime=this.audioContext.currentTime-e,this.jumpTo(e)},onOrientChange(e,o){console.log(e,o)},onVoiceRemove(e,o){this.doStop(),e.voiceSource.disconnect(),e.gainNode.disconnect(),e.disconnectReverb&&(e.disconnectReverb(),e.disconnectReverb=null),this.filelist.splice(o,1)},compose(){this.filelist.length?(this.doStop(),this.exportAudio(this.store.compress)):(0,K.P0)("请添加人声音频")},async exportAudio(e){let o,t=this.audioDuration,i=new OfflineAudioContext({numberOfChannels:2,length:48e3*t,sampleRate:48e3}),n=(0,X.A)(i);this.offlineAudioCtx=i,o=i.createBufferSource(),o.buffer=this.bgSource.buffer;let a=i.createGain();Tone.setContext(i);let s=new Tone.PitchShift;s.pitch=this.store.banzouPitch,o.connect(a),Tone.connect(a,s),Tone.connect(s,i.destination);let l=[];for(let r=0;r<this.filelist.length;r++){const e=this.filelist[r];let o=i.createBufferSource();o.buffer=e.voiceSource.buffer;let t=i.createGain(),a={reverb:e.reverb,reverbNode:new n.Effects.Reverb({time:e.reverbNode.time,decay:e.reverbNode.decay,mix:e.reverbNode.mix}),gainNode:t,voiceSource:o,delay:e.delay,volume:e.volume};console.log(a),t.gain.value=a.volume/100,o.connect(t),a.reverb?(t.connect(a.reverbNode),a.reverbNode.connect(i.destination)):t.connect(i.destination),this.startVoiceSource(0,a),l.push(o)}o.start(),console.log("start generate"),i.startRendering().then((o=>{this.offlineAudioCtx&&(console.log("渲染完成",o),e&&(0,K.P0)("正在压缩音频,可能要花费很长时间..."),(0,O.A)(o,i.length,e,(e=>{this.offlineAudioCtx&&this.store.showProgess(e)}),(()=>{this.store.hideProgess()})))})).catch((e=>{console.error("渲染错误:",e)})),(0,K.P0)("正在生成音频,请稍后..."),j.E.start(i,o.buffer.duration,(e=>{this.offlineAudioCtx&&(console.log("progess",e),this.store.showProgess(e))}),(()=>{this.store.hideProgess(),onlyVoice||(o.disconnect(),o.buffer=null);for(let e of l)e.disconnect(),e.buffer=null}))}}},M=t(1241);const Q=(0,M.A)(H,[["render",U],["__scopeId","data-v-2c5c7cbe"]]);var J=Q}}]);
//# sourceMappingURL=compose.7d4def81.js.map