"use strict";(self["webpackChunkallsing"]=self["webpackChunkallsing"]||[]).push([[739],{8197:function(e,t,o){o.r(t),o.d(t,{default:function(){return K}});var i=o(6768),n=o(4232),s=o(5130);const a=e=>((0,i.Qi)("data-v-c7ae6504"),e=e(),(0,i.jt)(),e),r={class:"container edit"},c={class:"content"},l={class:"c-e-name c-e-name-crop"},u={class:"c-e-ctrlbox"},h={class:"c-e-ctrlitem"},d={class:"c-e-sliderbox-time"},g={class:"c-e-sliderbox"},m={class:"c-e-sliderbox-time"},b={class:"c-co-lrcbox"},f={class:"c-e-editbox"},v={class:"c-e-title"},C=a((()=>(0,i.Lk)("span",null,"人声音量",-1))),p={class:"c-e-voicebox"},x={class:"c-e-title"},y=a((()=>(0,i.Lk)("span",null,"伴奏音量",-1))),k={class:"c-e-voicebox"},T={class:"c-e-title"},L=a((()=>(0,i.Lk)("span",null,"人声迟延",-1))),S={class:"c-e-voicebox"},V={class:"c-e-title"},A=a((()=>(0,i.Lk)("span",null,"混响",-1))),R={class:"c-reverb-gp"},w={class:"c-e-title"},D=a((()=>(0,i.Lk)("span",null,"压缩音频",-1))),G={class:"c-e-btnbox"};function P(e,t,o,a,P,F){const N=(0,i.g2)("van-nav-bar"),B=(0,i.g2)("van-icon"),_=(0,i.g2)("van-slider"),O=(0,i.g2)("van-button"),z=(0,i.g2)("van-switch"),E=(0,i.g2)("ReverbDialog");return(0,i.uX)(),(0,i.CE)(i.FK,null,[(0,i.Lk)("div",r,[(0,i.bF)(N,{title:"编辑","left-text":"主页",onClickLeft:t[0]||(t[0]=e=>F.onBack())}),(0,i.Lk)("div",c,[(0,i.Lk)("div",l,(0,n.v_)(P.musicName),1),(0,i.Lk)("div",u,[(0,i.Lk)("div",h,[(0,i.bo)((0,i.bF)(B,{name:"pause-circle-o",class:"c-e-ctrlicon",onClick:F.onPause},null,8,["onClick"]),[[s.aG,P.playing]]),(0,i.bo)((0,i.bF)(B,{name:"play-circle",class:"c-e-ctrlicon",onClick:F.onPlay},null,8,["onClick"]),[[s.aG,!P.playing]])]),(0,i.Lk)("div",d,(0,n.v_)(a.util.convertTime(P.curTime)),1),(0,i.Lk)("div",g,[(0,i.bF)(_,{modelValue:P.curTime,"onUpdate:modelValue":t[1]||(t[1]=e=>P.curTime=e),min:"0",max:a.store.recordLength,onChange:F.onDurationChange,onDragStart:t[2]||(t[2]=e=>P.dragging=!0),onDragEnd:t[3]||(t[3]=e=>P.dragging=!1)},null,8,["modelValue","max","onChange"])]),(0,i.Lk)("div",m,(0,n.v_)(a.util.convertTime(a.store.recordLength)),1)]),(0,i.Lk)("div",b,(0,n.v_)(P.curLrc),1),(0,i.Lk)("div",f,[(0,i.Lk)("div",v,[C,(0,i.Lk)("span",null,(0,n.v_)(P.humanVal),1)]),(0,i.Lk)("div",p,[(0,i.bF)(_,{min:"0",max:"100",modelValue:P.humanVal,"onUpdate:modelValue":t[4]||(t[4]=e=>P.humanVal=e),onChange:F.onHumanVoiceChange},null,8,["modelValue","onChange"])]),(0,i.Lk)("div",x,[y,(0,i.Lk)("span",null,(0,n.v_)(P.accompanyVal),1)]),(0,i.Lk)("div",k,[(0,i.bF)(_,{min:"0",max:"100",modelValue:P.accompanyVal,"onUpdate:modelValue":t[5]||(t[5]=e=>P.accompanyVal=e),onChange:F.onAccompanyVoiceChange},null,8,["modelValue","onChange"])]),(0,i.Lk)("div",T,[L,(0,i.Lk)("span",null,(0,n.v_)(a.store.voiceDelay),1)]),(0,i.Lk)("div",S,[(0,i.bF)(_,{min:"-1",max:"1",step:"0.1",modelValue:a.store.voiceDelay,"onUpdate:modelValue":t[6]||(t[6]=e=>a.store.voiceDelay=e),onChange:F.onDelayChange},null,8,["modelValue","onChange"])]),(0,i.Lk)("div",V,[A,(0,i.Lk)("div",R,[(0,i.bo)((0,i.bF)(O,{plain:"",type:"primary",size:"small",class:"c-e-cusbtn",onClick:F.onReverbSetting},{default:(0,i.k6)((()=>[(0,i.eW)("设置")])),_:1},8,["onClick"]),[[s.aG,a.store.reverb]]),(0,i.bF)(z,{modelValue:a.store.reverb,"onUpdate:modelValue":t[7]||(t[7]=e=>a.store.reverb=e),onChange:F.onReverbChange},null,8,["modelValue","onChange"])])]),(0,i.Lk)("div",w,[D,(0,i.bF)(z,{modelValue:a.store.compress,"onUpdate:modelValue":t[8]||(t[8]=e=>a.store.compress=e)},null,8,["modelValue"])])]),(0,i.Lk)("div",G,[(0,i.bF)(O,{plain:"",class:"c-e-btn",onClick:t[9]||(t[9]=e=>F.reRecord())},{default:(0,i.k6)((()=>[(0,i.eW)("重录")])),_:1}),(0,i.bF)(O,{plain:"",class:"c-e-btn",type:"danger",onClick:F.exportHuman},{default:(0,i.k6)((()=>[(0,i.eW)("导出人声")])),_:1},8,["onClick"]),(0,i.bF)(O,{class:"c-e-btn",type:"primary",onClick:F.exportSong},{default:(0,i.k6)((()=>[(0,i.eW)("导出歌曲")])),_:1},8,["onClick"])])])]),(0,i.bF)(E,{ref:"rbDlg",onChange:F.onReverbDetailChange},null,8,["onChange"])],64)}var F=o(144),N=o(5129),B=o(9353),_=o(5846),O=o(7019),z=o(2570),E=o(715),M=o(1104),U=o(6230);let j;var H={name:"EditView",components:{ReverbDialog:M.A},setup(){j=(0,U.A)(new(window.AudioContext||window.webkitAudioContext));const e=(0,N.A)(),t=(0,F.KR)(null);return{store:e,util:B.A,rbDlg:t}},data(){return{musicName:"",curLrc:"",curTime:0,remainTime:0,playing:!1,humanVal:90,accompanyVal:70,reverbMap:{},curReverbConvolver:null,audioContext:null,offlineAudioCtx:null,dragging:!1,bgGain:null,voiceGain:null,bgSource:null,voiceSource:null,rTimer:null,delayPlayTimer:null,bgSource:null,voiceSource:null}},mounted(){if(console.log("reverb",this.store.reverb),!this.store.audioChunk||!this.store.audioChunk.length||!this.store.banzou)return alert("没有找到需要编辑的音频"),void this.$router.replace("/");this.audioContext=j.context,this.store.recordLength||(this.store.recordLength=this.store.banzouLength),this.init([...this.store.audioChunk],this.store.banzou,this.store.recordLength),this.musicName=this.store.banzou.name.replace(/\.mp3$/i,"")},unmounted(){this.rTimer&&cancelAnimationFrame(this.rTimer),this.delayPlayTimer&&clearTimeout(this.delayPlayTimer);try{this.bgSource.disconnect(),this.bgSource.buffer=null,this.voiceSource.disconnect(),this.voiceSource.buffer=null}catch(e){}try{this.audioContext.close()}catch(e){console.log(e)}try{this.offlineAudioCtx&&("running"==this.offlineAudioCtx.state&&this.offlineAudioCtx.suspend(this.offlineAudioCtx.currentTime),this.offlineAudioCtx=null)}catch(e){console.log(e)}console.log("hide loading"),this.store.hideLoading(),this.store.hideProgess(),(0,O.H)(),_.E.stop(),j=null},methods:{onBack(){this.$router.replace("/")},reRecord(){(0,z.M5)({title:"提示",message:"是否要重录?"}).then((()=>{this.$router.replace("/record")})).catch((()=>{}))},async getReverb(e){const t="audio/reverb"+e+".wav";try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok "+e.statusText);const o=await e.arrayBuffer(),i=await this.audioContext.decodeAudioData(o);return console.log(i),i}catch(o){return console.error("There has been a problem with your fetch operation:",o),null}},async onReverbChange(e){e?(this.voiceGain.disconnect(),this.voiceGain.connect(this.curReverbNode),this.curReverbNode.connect(this.audioContext.destination)):(this.curReverbNode.disconnect(),this.voiceGain.disconnect(),this.voiceGain.connect(this.audioContext.destination))},onReverbDetailChange(e){this.curReverbNode&&(this.store.reverbOption={...e},this.curReverbNode.time=this.store.reverbOption.time,this.curReverbNode.decay=this.store.reverbOption.decay,this.curReverbNode.mix=this.store.reverbOption.mix)},onPlay(){this.doPlay()},onPause(){this.doStop()},onDurationChange(e){this.remainTime=this.audioContext.currentTime-e,this.jumpTo(e)},onAccompanyVoiceChange(e){this.bgGain&&(this.bgGain.gain.value=e/100,this.store.banzouVolume=e/100)},onHumanVoiceChange(e){this.voiceGain&&(this.voiceGain.gain.value=e/100)},exportSong(){this.doStop(),this.exportAudio(!1,this.store.compress)},exportHuman(){this.doStop(),this.exportAudio(!0,this.store.compress)},onDelayChange(){console.log(this.store.voiceDelay),this.jumpTo(this.curTime)},onReverbSetting(){this.rbDlg.show({...this.store.reverbOption})},async init(e,t,o){this.store.showLoading();const i=await this.loadAudioData(this.audioContext,t),n=this.audioContext.sampleRate,s=o*n,a=this.audioContext.createBuffer(2,s,n);a.getChannelData(0).set(i.getChannelData(0).subarray(0,s));let r=0;i.numberOfChannels>1&&(r=1),a.getChannelData(1).set(i.getChannelData(r).subarray(0,s));const c=this.audioContext.createBufferSource();c.buffer=a,this.bgGain=this.audioContext.createGain(),this.bgGain.gain.value=this.accompanyVal/100,c.connect(this.bgGain),Tone.setContext(this.audioContext);var l=new Tone.PitchShift;l.pitch=this.store.banzouPitch,Tone.connect(this.bgGain,l),Tone.connect(l,this.audioContext.destination);for(let d=e.length-1;d>=1;--d){const t=e[d],o=e[d-1];let i=t.start-o.end;if(i<0&&(o.end=t.start),i>0){let n=this.createSilentAudio(this.audioContext,i);e.splice(d,0,{start:o.end,end:t.start,buffer:n})}}const u=this.audioContext.createBuffer(2,s,n);for(let d=0;d<e.length;d++){let t,o=e[d];t=o.buffer?o.buffer:await this.loadAudioData(this.audioContext,o.blob);const i=Math.floor(o.start*n),a=Math.min(i+t.length,s);u.getChannelData(0).set(t.getChannelData(0).slice(0,Math.floor(a-i)),i);let r=0;console.log("channel "+t.numberOfChannels),t.numberOfChannels>1&&(r=1),u.getChannelData(1).set(t.getChannelData(r).slice(0,Math.floor(a-i)),i)}const h=this.audioContext.createBufferSource();h.buffer=u,this.voiceGain=this.audioContext.createGain(),this.voiceGain.gain.value=this.humanVal/100,h.connect(this.voiceGain),this.curReverbNode=new j.Effects.Reverb({...this.store.reverbOption}),this.onReverbChange(this.store.reverb),this.audioContext.onstatechange=()=>{console.log("state-> ",this.audioContext.state)},console.log("delay time->",this.audioContext.currentTime),this.bgSource=c,this.voiceSource=h,this.playing=!0,this.remainTime=this.audioContext.currentTime,this.setCurTime(),c.start(),this.startVoiceSource(),console.log("voiceSource",h),this.store.hideLoading()},doStop(e){console.log(this.audioContext.state),"running"==this.audioContext.state&&(this.playing=!1,this.audioContext.suspend(),e&&(this.curTime=0,this.rTimer=null,this.remainTime=this.audioContext.currentTime))},jumpTo(e){this.bgSource.stop();const t=this.audioContext.createBufferSource();t.buffer=this.bgSource.buffer,this.bgSource.disconnect(),this.bgSource.buffer=null,t.connect(this.bgGain),this.bgSource=t,console.log("bg",0,e),this.bgSource.start(0,e),this.voiceSource.stop();const o=this.audioContext.createBufferSource();o.buffer=this.voiceSource.buffer,this.voiceSource.disconnect(),this.voiceSource.buffer=null,o.connect(this.voiceGain),this.voiceSource=o,this.startVoiceSource(e)},startVoiceSource(e=0,t=this.voiceSource){this.delayPlayTimer&&(clearTimeout(this.delayPlayTimer),this.delayPlayTimer=null);let o=0;if(o=e+this.store.voiceDelay,o>=0)t.start(0,o);else{let e=-1e3*o;o=0,this.delayPlayTimer=setTimeout((()=>{t.start(0,o)}),e)}},doPlay(){console.log(this.audioContext.state),"running"!=this.audioContext.state&&(this.playing=!0,this.audioContext.resume(),this.rTimer||(this.setCurTime(),this.jumpTo(0)))},setCurTime(){let e=this.audioContext.currentTime-this.remainTime;e>=this.store.recordLength?this.doStop(!0):(this.dragging||(this.curTime=e),this.setCurLrc(),this.rTimer=requestAnimationFrame(this.setCurTime))},setCurLrc(){if(!this.store.parsedLyrics||!this.store.parsedLyrics.length)return;const e=this.curTime;for(let t=0;t<this.store.parsedLyrics.length;t++)if(e>=this.store.parsedLyrics[t].time&&(t===this.store.parsedLyrics.length-1||e<this.store.parsedLyrics[t+1].time)){this.curLrc=this.store.parsedLyrics[t].text;break}},createSilentAudio(e,t){const o=2,i=e.sampleRate*t,n=e.createBuffer(o,i,e.sampleRate);return n},loadAudioData(e,t){return new Promise(((o,i)=>{const n=new FileReader;n.onload=()=>{e.decodeAudioData(n.result).then((e=>o(e))).catch((e=>i(e)))},n.onerror=()=>i(n.error),n.readAsArrayBuffer(t)}))},async exportAudio(e,t){let o,i=this.store.recordLength,n=new OfflineAudioContext({numberOfChannels:2,length:48e3*i,sampleRate:48e3}),s=(0,U.A)(n);if(this.offlineAudioCtx=n,!e){o=n.createBufferSource(),o.buffer=this.bgSource.buffer;let e=n.createGain();Tone.setContext(n);let t=new Tone.PitchShift;t.pitch=this.store.banzouPitch,o.connect(e),Tone.connect(e,t),Tone.connect(t,n.destination)}let a=n.createBufferSource();a.buffer=this.voiceSource.buffer;let r=n.createGain();if(r.gain.value=this.humanVal/100,a.connect(r),this.store.reverb){let e=new s.Effects.Reverb({time:this.curReverbNode.time,decay:this.curReverbNode.decay,mix:this.curReverbNode.mix});r.connect(e),e.connect(n.destination)}else r.connect(n.destination);e||o.start(),this.startVoiceSource(0,a),console.log("start generate"),n.startRendering().then((e=>{this.offlineAudioCtx&&(console.log("渲染完成",e),t&&(0,E.P0)("正在压缩音频,可能要花费很长时间..."),(0,O.A)(e,n.length,t,(e=>{this.offlineAudioCtx&&this.store.showProgess(e)}),(()=>{this.store.hideProgess()})))})).catch((e=>{console.error("渲染错误:",e)})),(0,E.P0)("正在生成音频,请稍后..."),_.E.start(n,this.bgSource.buffer.duration,(e=>{this.offlineAudioCtx&&(console.log("progess",e),this.store.showProgess(e))}),(()=>{this.store.hideProgess(),e||(o.disconnect(),o.buffer=null),a.disconnect(),a.buffer=null}))}}},W=o(1241);const $=(0,W.A)(H,[["render",P],["__scopeId","data-v-c7ae6504"]]);var K=$}}]);
//# sourceMappingURL=edit.24c5dc5f.js.map