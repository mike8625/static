"use strict";(self["webpackChunkallsing"]=self["webpackChunkallsing"]||[]).push([[692],{3822:function(e,t,i){i.d(t,{A:function(){return p}});var o=i(6768);const n={class:"c-setting-box"},s={class:"c-setting-sliderbox"},a={class:"c-setting-sliderbox"},r={class:"c-setting-sliderbox"},l={class:"c-setting-sliderbox"};function h(e,t,i,h,c,u){const d=(0,o.g2)("van-cell"),m=(0,o.g2)("van-slider"),g=(0,o.g2)("van-radio"),p=(0,o.g2)("van-radio-group"),C=(0,o.g2)("van-dialog");return(0,o.uX)(),(0,o.Wv)(C,{show:h.isVisible,"onUpdate:show":t[4]||(t[4]=e=>h.isVisible=e),title:"设置",onClose:h.onCloseDialog},{default:(0,o.k6)((()=>[(0,o.Lk)("div",n,[(0,o.bF)(d,{title:"歌词同步",value:h.store.lrcDelayTime},null,8,["value"]),(0,o.Lk)("div",s,[(0,o.bF)(m,{modelValue:h.store.lrcDelayTime,"onUpdate:modelValue":t[0]||(t[0]=e=>h.store.lrcDelayTime=e),onChange:u.onlrcDelayChange,min:"-2",max:"2",step:"0.1"},null,8,["modelValue","onChange"])]),(0,o.bF)(d,{title:"歌词编码"}),(0,o.Lk)("div",a,[(0,o.bF)(p,{modelValue:h.store.lrcEncoding,"onUpdate:modelValue":t[1]||(t[1]=e=>h.store.lrcEncoding=e),direction:"horizontal",onChange:u.onLrcEncodingChange},{default:(0,o.k6)((()=>[(0,o.bF)(g,{name:"GBK"},{default:(0,o.k6)((()=>[(0,o.eW)("GBK")])),_:1}),(0,o.bF)(g,{name:"UTF-8"},{default:(0,o.k6)((()=>[(0,o.eW)("UTF-8")])),_:1})])),_:1},8,["modelValue","onChange"])]),(0,o.bF)(d,{title:"伴奏音量",value:100*h.store.banzouVolume},null,8,["value"]),(0,o.Lk)("div",r,[(0,o.bF)(m,{modelValue:h.store.banzouVolume,"onUpdate:modelValue":t[2]||(t[2]=e=>h.store.banzouVolume=e),onChange:u.onBanzouVolumeChange,min:"0",max:"1",step:"0.1"},null,8,["modelValue","onChange"])]),(0,o.bF)(d,{title:"伴奏音调",value:10*h.store.banzouPitch},null,8,["value"]),(0,o.Lk)("div",l,[(0,o.bF)(m,{modelValue:h.store.banzouPitch,"onUpdate:modelValue":t[3]||(t[3]=e=>h.store.banzouPitch=e),onChange:u.onBanzouPitchChange,min:"-1.1",max:"1.1",step:"0.1"},null,8,["modelValue","onChange"])])])])),_:1},8,["show","onClose"])}var c=i(5129),u=i(144),d={name:"setting",props:{visible:{type:Boolean,default:!1}},emits:["update:visible"],setup(e,{emit:t}){const i=(0,c.A)(),n=(0,u.KR)(e.visible);(0,o.wB)((()=>e.visible),(e=>{console.log(e),n.value=e}));let s=()=>{console.log("关闭对话框"),t("update:visible",!1)};return{store:i,isVisible:n,onCloseDialog:s}},methods:{onlrcDelayChange(e){this.store.parseLRC()},onLrcEncodingChange(e){this.store.readLrcText()},onBanzouVolumeChange(e){this.store.banzouVolume=e},onBanzouPitchChange(e){this.store.banzouPitch=e}}},m=i(1241);const g=(0,m.A)(d,[["render",h],["__scopeId","data-v-521478c4"]]);var p=g},6533:function(e,t,i){i.r(t),i.d(t,{default:function(){return S}});var o=i(6768),n=i(4232),s=i(5130);const a=e=>((0,o.Qi)("data-v-f2fbb144"),e=e(),(0,o.jt)(),e),r={class:"container record"},l={class:"content c-text-center"},h={class:"c-lrcbox"},c={class:"c-cd-dotbox"},u={class:"c-ctrlbox"},d=a((()=>(0,o.Lk)("span",null,"重唱",-1))),m={class:"c-ctrlitem"},g=a((()=>(0,o.Lk)("span",null,"完成",-1))),p={class:"c-timebox"},C={ref:"waveBox",width:"375",height:"40",class:"c-re-wave"};function w(e,t,i,a,w,v){const b=(0,o.g2)("van-nav-bar"),f=(0,o.g2)("van-picker"),T=(0,o.g2)("van-icon"),y=(0,o.g2)("van-button"),k=(0,o.g2)("van-action-sheet"),L=(0,o.g2)("SettingDialog");return(0,o.uX)(),(0,o.CE)(o.FK,null,[(0,o.Lk)("div",r,[(0,o.bF)(b,{title:w.musicName,"left-text":"主页",onClickLeft:t[0]||(t[0]=e=>v.onBack()),"right-text":"设置",onClickRight:v.onSetting},null,8,["title","onClickRight"]),(0,o.Lk)("audio",{ref:"audio",onTimeupdate:t[1]||(t[1]=(...e)=>v.onTimeUpdate&&v.onTimeUpdate(...e)),style:{display:"none"},onEnded:t[2]||(t[2]=(...e)=>v.finish&&v.finish(...e)),onLoadedmetadata:t[3]||(t[3]=(...e)=>v.onLoadedMetadata&&v.onLoadedMetadata(...e))},null,544),(0,o.Lk)("div",l,[(0,o.Lk)("div",h,[(0,o.bF)(f,{onTouchstart:v.onTouchStart,onTouchend:v.onTouchEnd,class:(0,n.C4)(v.getCurClass()),"show-toolbar":!1,columns:a.store.parsedLyrics,onChange:v.onChange,modelValue:w.curVal,"onUpdate:modelValue":t[4]||(t[4]=e=>w.curVal=e),readonly:w.countingdown||!w.playing,"visible-option-num":"8","option-height":"8vh","swipe-duration":"400"},null,8,["onTouchstart","onTouchend","class","columns","onChange","modelValue","readonly"]),(0,o.bo)((0,o.Lk)("div",c,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(w.dotCount,(e=>((0,o.uX)(),(0,o.CE)("i",{key:e,class:"c-cd-dotitem"})))),128))],512),[[s.aG,w.countingdown]])]),(0,o.Lk)("div",u,[(0,o.Lk)("div",{class:"c-ctrlitem",onClick:t[5]||(t[5]=(...e)=>v.onReplay&&v.onReplay(...e))},[(0,o.bF)(T,{name:"revoke",class:"c-ctrlicon"}),d]),(0,o.Lk)("div",m,[(0,o.bo)((0,o.bF)(T,{name:"pause-circle-o",class:"c-ctrlicon-big",onClick:v.onPause},null,8,["onClick"]),[[s.aG,w.playing]]),(0,o.bo)((0,o.bF)(T,{name:"play-circle",class:"c-ctrlicon-big",onClick:v.onPlay},null,8,["onClick"]),[[s.aG,!w.playing]])]),(0,o.Lk)("div",{class:"c-ctrlitem",onClick:t[6]||(t[6]=(...e)=>v.onFinish&&v.onFinish(...e))},[(0,o.bF)(T,{name:"passed",class:"c-ctrlicon"}),g])]),(0,o.Lk)("div",p,(0,n.v_)(a.util.convertTime(w.curTime))+" / "+(0,n.v_)(a.util.convertTime(a.store.banzouLength)),1),(0,o.Lk)("div",null,[(0,o.bo)((0,o.bF)(y,{class:"c-jump-btn",plain:"",type:"default",onClick:v.jumpToSing},{default:(0,o.k6)((()=>[(0,o.eW)("跳过前奏")])),_:1},8,["onClick"]),[[s.aG,w.jumpShow]])]),(0,o.Lk)("canvas",C,null,512)])]),(0,o.bF)(k,{show:w.fShow,"onUpdate:show":t[7]||(t[7]=e=>w.fShow=e),actions:w.fShowList,onSelect:v.onFshowSelect,"cancel-text":"取消","close-on-click-action":"",onCancel:v.onFshowCancel},null,8,["show","actions","onSelect","onCancel"]),(0,o.bF)(L,{visible:w.settingShow,"onUpdate:visible":t[8]||(t[8]=e=>w.settingShow=e)},null,8,["visible"])],64)}i(4114),i(6573),i(8100),i(7936),i(7467),i(4732),i(9577),i(4603),i(7566),i(8721);var v=i(5129),b=i(2570),f=i(3822),T=i(9353),y={name:"RecordView",components:{SettingDialog:f.A},setup(){const e=(0,v.A)();return{store:e,util:T.A}},data(){return{musicName:"",curTime:0,jumpShow:!1,audioUrl:null,curVal:[],countingdown:!1,dotCount:5,needCountdown:!1,showCountdownTime:null,scrolling:!1,playing:!1,fShow:!1,fShowList:[{name:"结束在当前位置"},{name:"结束并保留之后的伴奏"}],mediaRecorder:null,recordStarttime:0,settingShow:!1,audioCtx:null,pitchShift_banzou:null,gainNode_banzou:null,analyser:null,ctx:null}},mounted(){if(console.log(this.store),!this.store.banzou)return alert("请先选择伴奏文件"),void this.$router.replace("/");navigator.mediaDevices.getUserMedia({audio:{channelCount:2,sampleRate:48e3,sampleSize:16,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!0}}).then((e=>{this.initMediaRecorder(e),this.musicName=this.store.banzou.name.replace(/\.(mp3|wav)$/i,""),this.store.audioChunk=[],this.connectAuido(),this.initAnalyser(e),this.store.lrc?this.store.readLrcText().then((()=>{this.store.parsedLyrics[0]&&this.setCountdownTime(this.store.parsedLyrics[0].value),this.loadAudio()})):this.loadAudio()})).catch((e=>{console.log(e),alert("麦克风权限请求失败,无法进行录音")}))},unmounted(){this.audioUrl&&(URL.revokeObjectURL(this.audioUrl),this.audioUrl=null),this.$refs.audio&&(this.$refs.audio.pause(),this.$refs.audio.src=""),this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null),this.clearTimer()},watch:{"store.banzouVolume":{handler(){this.audioCtx&&(this.gainNode_banzou.gain.value=this.store.banzouVolume)}},"store.banzouPitch":{handler(){this.audioCtx&&(this.pitchShift_banzou.pitch=this.store.banzouPitch)}}},methods:{test1(){console.log("test1"+this.store)},initAnalyser(e){const t=this.audioCtx.createMediaStreamSource(e);this.analyser=this.audioCtx.createAnalyser(),this.analyser.fftSize=2048,t.connect(this.analyser);let i=this.$refs.waveBox;this.ctx=i.getContext("2d"),this.drawWaveform()},drawWaveform(){const e=this.analyser.fftSize,t=new Uint8Array(e);let i=this.$refs.waveBox,o=this.ctx,n=()=>{this.analyser.getByteTimeDomainData(t),o.clearRect(0,0,i.width,i.height),o.lineWidth=1.5,o.strokeStyle="#e4310d",o.beginPath();const s=1*i.width/e;let a=0;for(let n=0;n<e;n++){const e=t[n]/128,r=e*i.height/2;0===n?o.moveTo(a,r):o.lineTo(a,r),a+=s}o.lineTo(i.width,i.height/2),o.stroke(),this.animationId=requestAnimationFrame(n)};n()},checkQianzouLength(){this.store.parsedLyrics&&this.store.parsedLyrics.length&&this.store.parsedLyrics[0].time>10&&(this.jumpShow=!0)},jumpToSing(){let e=this.store.parsedLyrics[0].value;this.curVal=[e],this.onChange({selectedValues:[e]}),this.changeTime(),this.jumpShow=!1},clearTimer(){clearTimeout(this.cdTimer),clearTimeout(this.delayTimer),clearTimeout(this.touchEndTimer),cancelAnimationFrame(this.animationId)},onSetting(){this.settingShow=!0},setMediaRecorder(){this.mediaRecorder.ondataavailable=e=>{console.log(e.data),this.$refs.audio&&(this.store.audioChunk.push({start:this.recordStarttime,end:this.$refs.audio.currentTime,blob:e.data}),console.log(this.store.audioChunk))}},initMediaRecorder(e){this.mediaRecorder=new MediaRecorder(e),this.setMediaRecorder()},removeRecordedSegmentsAfter(e){this.store.audioChunk=this.store.audioChunk.filter((t=>t.start<e))},createSilentAudio(e){const t=this.audioCtx,i=2,o=t.sampleRate*e,n=t.createBuffer(i,o,t.sampleRate);return n},getCurClass(){let e=[];return this.dotCount<=0&&e.push("c-start-sing"),this.scrolling&&e.push("c-picker-scrolling"),e.join(" ")},onTouchStart(){!this.countingdown&&this.playing&&(console.log("onTouchStart"),this.touchEndTimer?(clearTimeout(this.touchEndTimer),this.touchEndTimer=null):this.touchTime=this.$refs.audio.currentTime,this.scrolling=!0)},onTouchEnd(){!this.countingdown&&this.playing&&(console.log("will onTouchEnd"),this.touchEndTimer=setTimeout((()=>{console.log("onTouchEnd"),this.scrolling=!1,this.touchEndTimer=null,this.changeTime()}),500))},loadAudio(){this.audioUrl=window.URL.createObjectURL(this.store.banzou),this.$refs.audio.src=this.audioUrl},onLoadedMetadata(){this.store.banzouLength=this.$refs.audio.duration,this.mediaRecorder.start(),this.$refs.audio.play(),this.playing=!0,this.checkQianzouLength()},connectAuido(){var e=new(window.AudioContext||window.webkitAudioContext),t=this.$refs.audio,i=e.createMediaElementSource(t),o=e.createGain();i.connect(o),Tone.setContext(e),o.gain.value=this.store.banzouVolume;var n=new Tone.PitchShift;n.pitch=this.store.banzouPitch,Tone.connect(o,n),Tone.connect(n,e.destination),this.audioCtx=e,this.gainNode_banzou=o,this.pitchShift_banzou=n},onBack(){this.$router.replace("/")},setCountdownTime(e){this.showCountdownTime=e<5?0:e-5,this.needCountdown=!0},onPause(){this.countingdown||(this.$refs.audio.pause(),this.mediaRecorder.pause(),this.playing=!1)},onPlay(){this.countingdown||(this.$refs.audio.play(),this.mediaRecorder.resume(),this.playing=!0)},onTimeUpdate(){const e=this.$refs.audio;if(!e)return;if(this.curTime=e.currentTime,this.countingdown||this.scrolling)return;console.log("---------onTimeUpdate");const t=e.currentTime;if(this.needCountdown&&t>=this.showCountdownTime){this.jumpShow=!1;let e=t-this.showCountdownTime,i=Math.floor(e),o=1e3-1e3*(e-i);return this.dotCount=Math.floor(5-(e-i)),this.dotCount<0?(this.dotCount=0,void(this.needCountdown=!1)):(this.countingdown=!0,this.delayTimer=setTimeout((()=>{this.countdown().then((()=>{this.countingdown=!1,"recording"!==this.mediaRecorder.state&&(this.mediaRecorder.start(),this.recordStarttime=this.$refs.audio.currentTime,this.removeRecordedSegmentsAfter(this.recordStarttime))}))}),o),void(this.needCountdown=!1))}if(!this.countingdown)for(let i=0;i<this.store.parsedLyrics.length;i++)if(t>=this.store.parsedLyrics[i].time&&(i===this.store.parsedLyrics.length-1||t<this.store.parsedLyrics[i+1].time)){this.curVal=[this.store.parsedLyrics[i].value];break}},onChange({selectedValues:e}){"recording"===this.mediaRecorder.state&&this.mediaRecorder.stop(),this.valueChangeTime=e[0]},changeTime(){if(this.scrolling||!this.valueChangeTime)return;let e=this.valueChangeTime-5;e<0&&(e=0),console.log("n-> ",e),this.$refs.audio.currentTime=e,this.setCountdownTime(this.valueChangeTime),this.valueChangeTime=null},countdown(){return new Promise((e=>{this.countingdown=!0;let t=()=>{this.dotCount>0?this.cdTimer=setTimeout((()=>{this.dotCount--,t()}),1e3):e()};t()}))},onReplay(){1!=this.countingdown&&(0,b.M5)({title:"提示",message:"是否要重录?"}).then((()=>{this.doReplay()})).catch((()=>{}))},doReplay(){this.clearTimer(),this.$refs.audio.pause(),this.$refs.audio.currentTime=0,this.countingdown=!1,this.dotCount=5,this.valueChangeTime=null,this.showCountdownTime=null,this.store.lrc&&this.store.parsedLyrics.length&&(this.curVal=[this.store.parsedLyrics[0].value],this.setCountdownTime(this.store.parsedLyrics[0].value)),this.mediaRecorder.ondataavailable=()=>{},this.mediaRecorder.stop(),this.setMediaRecorder(),this.recordStarttime=0,this.store.audioChunk=[],this.mediaRecorder.start(),this.drawWaveform(),this.$refs.audio.play(),this.playing=!0,this.checkQianzouLength()},onFinish(){1!=this.countingdown&&(console.log("onFinish"),this.$refs.audio.paused?this.isAlreadyPaused=!0:(this.$refs.audio.pause(),this.isAlreadyPaused=!1),this.fShow=!0)},finish(){console.log("finish"),this.$refs.audio.pause(),this.mediaRecorder.stop(),setTimeout((()=>{this.$router.push({path:"/edit"})}),50)},onFshowCancel(){this.fShow=!1,this.isAlreadyPaused||this.$refs.audio.play()},onFshowSelect(e,t){console.log(e,t),0==t?this.store.recordLength=this.$refs.audio.currentTime:1==t&&(this.store.recordLength=0),this.finish()}}},k=i(1241);const L=(0,k.A)(y,[["render",w],["__scopeId","data-v-f2fbb144"]]);var S=L}}]);
//# sourceMappingURL=record.a5d2bd96.js.map